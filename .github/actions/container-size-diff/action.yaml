---
# yaml-language-server: $schema=https://json.schemastore.org/github-action.json
name: Container Size Diff
description: Creates a Markdown summary of the size difference between two container versions

inputs:
  from-container:
    description: Baseline container image for size comparison
    required: true
  to-container:
    description: Container image to be compared to the baseline
    required: true

outputs:
  size-diff-markdown:
    description: Markdown formatted output of container size comparison
    value: ${{ steps.size-diff.outputs.markdown }}

runs:
  using: composite
  steps:
    - name: Setup Node
      uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5.0.0
      with:
        node-version: 22.x

    - name: Setup Node Dependencies
      shell: bash
      run: npm install execa@9 filesize@11 lodash@4 markdown-table@3

    - name: Container Size Diff
      uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
      id: size-diff
      with:
        script: |
          const { execaSync } = require("execa");
          const { filesize } = require("filesize");
          const { markdownTable } = require("markdown-table");
          const _ = require("lodash");

          const fromContainer = '${{ inputs.from-container }}';
          const toContainer = '${{ inputs.to-container }}';

          async function getSizes(container) {
              try {
                  const { stdout } = execaSync("docker", ["manifest", "inspect", "-v", container]);
                  const manifests = _.castArray(JSON.parse(stdout.trim()));

                  return _(manifests)
                      .map(m => {
                          const platform = _.get(m, 'Descriptor.platform', {});

                          if (_.isEmpty(platform) || (!platform.os && !platform.architecture)) {
                              return null;
                          }

                          const key = _.compact([
                              platform.os,
                              platform.architecture,
                              platform.variant,
                              platform["os.version"]
                          ]).join("/") || "unknown";

                          const layers = _.get(m, 'OCIManifest.layers') || _.get(m, 'layers', []);
                          const total = _.sumBy(layers, 'size');

                          return [key, total];
                      })
                      .compact()
                      .fromPairs()
                      .value();
              } catch (e) {
                  core.error(`Failed to inspect ${container}: ${e.message}`);
                  return {};
              }
          }

          const fromSizes = await getSizes(fromContainer);
          const toSizes   = await getSizes(toContainer);

          const allPlatforms = _.union(_.keys(fromSizes), _.keys(toSizes)).sort();

          const total = sizes => _.sum(_.values(sizes));
          const delta = total(toSizes) - total(fromSizes);

          const createPlatformRow = (platform) => {
              const previous = _.get(fromSizes, platform, 0);
              const current = _.get(toSizes, platform, 0);
              const change = current - previous;

              const percentage = previous
                  ? `${change >= 0 ? "+" : ""}${_.round(change / previous * 100, 2)}%`
                  : current ? "+âˆž" : "+0.00%";

              const icon = _.cond([
                  [change => change < 0, _.constant("ðŸ”½")],
                  [change => change > 0, _.constant("ðŸ”¼")],
                  [_.stubTrue, _.constant("ðŸ”„")]
              ])(change);

              return [
                  platform,
                  filesize(previous),
                  filesize(current),
                  `${change >= 0 ? "+" : ""}${filesize(Math.abs(change))} (${percentage})`,
                  icon
              ];
          };

          const rows = [
              ["OS/Platform", "Previous", "Current", "Change", "Trend"],
              ..._.map(allPlatforms, createPlatformRow)
          ];

          const totalFromSize = total(fromSizes) || 1;
          const percentageChange = _.round(delta / totalFromSize * 100, 2);

          const output = `## ðŸ“¦ Container Size Analysis

          Comparing \`${fromContainer}\` â†’ \`${toContainer}\`

          ðŸ“Š **Total Change:** ${filesize(delta)} (${percentageChange}%)

          ### ðŸ“ˆ Size Comparison Table

          ${markdownTable(rows, { align: ["l", "c", "c", "c", "c"] })}`;

          core.setOutput("markdown", output);
